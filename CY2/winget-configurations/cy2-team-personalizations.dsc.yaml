properties:
  configurationVersion: 0.2.0
  ########################################
  ### RESOURCES: System Configuration
  ########################################
  resources:
  ########################################
  ### Install Tools
  #########################################
  ### Powershell Config  
  ########################################
  ### Run install Elastic agent script
  ### -------------------------------------
    - resource: PSDscResources/Script
      id: installelasticagent
      directives:
        description: Installs the Elastic agent
      settings:
        SetScript: |
          # Install Elastic Agent
          $ProgressPreference = 'SilentlyContinue'
          Invoke-WebRequest -Uri https://artifacts.elastic.co/downloads/beats/elastic-agent/elastic-agent-8.15.3-windows-x86_64.zip -OutFile elastic-agent-8.15.3-windows-x86_64.zip
          Expand-Archive .\elastic-agent-8.15.3-windows-x86_64.zip -DestinationPath .
          cd elastic-agent-8.15.3-windows-x86_64
          .\elastic-agent.exe install -f --url=https://b1d6944f978c4e718656dfead30f3395.fleet.eu-west-2.aws.cloud.es.io:443 --enrollment-token=Um1XVDJKSUJXTVE4MHpTdW5RNUk6aGRfbVptcU9TRjZmSEFHMjUzMS0wZw==
        GetScript: return $false
        TestScript: return $false
  
  ########################################
  ### Run powershell cleanup script
  ### -------------------------------------
    - resource: PSDscResources/Script
      id: runcleanup
      directives:
        description: Runs cleanup items
      settings:
        SetScript: |
          # Get Username of logged in user
          $env:Path = [System.Environment]::GetEnvironmentVariable("Path","Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path","User")
          $username = $env:USERNAME
          
          # Add to docker-users group
          $username = [System.Security.Principal.WindowsIdentity]::GetCurrent().Name
          Add-LocalGroupMember -Group "docker-users" -Member $username
          
          # Remove temp files
          Remove-Item -Path "C:\src\devboxcentercatalog\" -Recurse -Force

          # Remove admin permissions and force restart machine
          Remove-LocalGroupMember -Group "Administrators" -Member $username
          shutdown /r /f
        GetScript: return $false
        TestScript: return $false

