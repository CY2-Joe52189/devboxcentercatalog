properties:
  configurationVersion: 0.2.0
  ########################################
  ### RESOURCES: System Configuration
  ########################################
  resources:
  ########################################
  ### Install Tools
  #########################################
  ### Powershell Config  
  ########################################
  ### Run powershell cleanup script
  ### -------------------------------------
    - resource: PSDscResources/Script
      id: runcleanup
      directives:
        description: Runs cleanup items
      settings:
        SetScript: |
          # Get Username of logged in user
          $env:Path = [System.Environment]::GetEnvironmentVariable("Path","Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path","User")
          $username = $env:USERNAME
          
          # Enable WSL
          dism.exe /online /enable-feature /featurename:Microsoft-Windows-Subsystem-Linux /all /norestart 
          dism.exe /online /enable-feature /featurename:VirtualMachinePlatform /all /norestart
          Start-Process msiexec.exe -ArgumentList '/i', 'C:\temp\wsl_update_x64.msi', '/quiet', '/norestart' -Wait
          wsl --set-default-version 2
          wsl --update

          # Path to the Docker Desktop settings file
          $dockerSettingsPath = "$env:APPDATA\Docker\settings.json"
          # Read the settings file content
          $settings = Get-Content -Path $dockerSettingsPath -Raw | ConvertFrom-Json
          # Set the configuration to skip the first run setup
          $settings.SkipStartupTips = $true
          $settings.CliOnboardingEnabled = $false
          # Write the changes back to the settings file
          $settings | ConvertTo-Json -Compress | Set-Content -Path $dockerSettingsPath 
          
          # Add to docker-users group
          $username = [System.Security.Principal.WindowsIdentity]::GetCurrent().Name
          Add-LocalGroupMember -Group "docker-users" -Member $username
          
          # Remove temp files
          Remove-Item -Path "C:\src\devboxcentercatalog\" -Recurse -Force
          Remove-Item -Path "C:\temp\" -Recurse -Force

          # Remove admin permissions and force restart machine
          Remove-LocalGroupMember -Group "Administrators" -Member $username
          shutdown /r /f
        GetScript: return $false
        TestScript: return $false

